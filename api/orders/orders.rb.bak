#curl -X POST https://vedantdomain.cz/objednavky -d '{"date":"2016-10-25", "meals":3}' -H 'Authentication: 12345abcd' -H 'Content-Type: application/json'

require 'grape'
require 'pry'

module API

  class Orders < Grape::API

    format :json


    rescue_from :all


    error_formatter :json, lambda { |message, backtrace, options, env|
      {
        status: 'failed',
        message: message,
        error_code: 123
      }.to_json
    }

#   ..better way of reporting errors

#    rescue_from Grape::Exceptions::ValidationErrors do |e|
#      rack_response({
#      status: e.status,
#      error_msg: e.message,
#      }.to_json, 400)
#    end

    resource :api do
      mount '/'
 
 #     def index
#       @address_links = policy_scope(AddressLink)
  #    end

   #   def show
#      end

 #     def new
#       @address_link = current_user.address_links.build
  #    end

   #   def edit
    #  end

     # def create
      #end
      desc 'End-points for Orders'
      #namespace :orders do

        desc '#get orders'
        #index do
        
          get :orders do

            token = headers['Authorization']

            { 
              token: token,
              status: :ok
            }
          end
        #end

        desc '#create order'
        #create do
          post :orders do
            params do
              requires :order do
                requires :date, type: Date
                requires :count, type: Integer
                requires :meal_number, type: Integer
                requires :box, type: Boolean
              end
            end

            token = headers['Authorization']


#       .. nice proc for getting current_user
#def current_user
#   return nil if headers['Authorization'].nil?
#    @current_user ||= User.find_by_authentication_token(
#      headers['Authorization']
#    )
#  end

            date = params[:date] 
            count = params[:count]
            meal_number = params[:meal_number]
            box = params[:box]


            {
              token: token,
              date: date,
              count: count,
              meal_number: meal_number,
              box: box, 
              status: :created
            }

          end

    end #resource api

  end #class Orders

end #module API
